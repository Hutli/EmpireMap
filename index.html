<!DOCTYPE html>
<!-- saved from url=(0066)https://leafletjs.com/examples/crs-simple/crs-simple-example1.html -->
<html id="index">
	<head>
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#2b5797">
		<meta name="theme-color" content="#ffffff">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		
		<title>The Empire</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" type="text/css" href="css/myleaflet.css">
		<link rel="stylesheet" type="text/css" href="css/poiinfo.css">
		<link rel="stylesheet" type="text/css" href="css/sidenav.css">
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>

	   	<!-- Make sure this exists AFTER Leaflet's CSS -->
	 	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
	   	<script src="js/jquery-3.3.1.js"></script>
		
	</head>
	<body data-gr-c-s-loaded="true" class="noscrol">
		<div id="mySidenav" class="sidenav">
			<div class="content">
				<h2>Nations</h2>
			    <a>The Marches</a><br/>
			    <a>Wintermark</a><br/>
			    <a>Dawn</a><br/>
			    <a>Highguard</a><br/>
			    <a>The League</a><br/>
		    </div>
		    <div class="footer">
		    	<hr>
			    <h2>Tips:</h2>
				<ul>
				  	<li>Hold control to open wiki</li>
				</ul>
			</div>
		</div>

		<div id="poiInfoPanel" class="poiInfo">
		</div>

		<div id="map" class="main"></div>

		<script>
			var map = L.map('map', {
				minZoom: -2,
				crs: L.CRS.Simple
			});

			var isCtrlKeyPressed = false;
			var bounds = [[0,0], [4811,6428]];
			var image = L.imageOverlay('images/main.png', bounds).addTo(map);

			var geojson = new L.geoJson();
			var nationsData = {};

			var xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function() {
			    if (this.readyState == 4 && this.status == 200) {
			        nationsData = JSON.parse(this.responseText);
			        createMap(nationsData);

			    }
			};
			xmlhttp.open("GET", "data/geodata.json", true);
			xmlhttp.send();

			/*var geojson = L.geoJson(nationsData, {
			    style: style,
			    onEachFeature: onEachFeature
			});*/

			function createMap(data){
				map.removeLayer(geojson);

				geojson = L.geoJson(data, {
				    style: style,
				    onEachFeature: onEachFeature
				}).addTo(map);
			}

			function style(feature) {
			    return {
			        weight: 1,
			        opacity: 1,
			        color: 'black',
			        dashArray: '3',
			        fillOpacity: 0
			    };
			}

			function highlightFeature(e) {
			    var layer = e.target;
			    if(layer.feature.geometry.type == "Polygon"){
				    layer.setStyle({
				        weight: 5,
				        color: '#666',
				        dashArray: '',
				        fillOpacity: 0.7
				    });

				    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
				        layer.bringToFront();
				    }
			}
			    info.update(layer.feature.properties);
			}

			function resetHighlight(e) {
			    geojson.resetStyle(e.target);
			    info.update();
			}

			var isFeatureClicked = false;
			function featureClicked(e) {
				if(isCtrlKeyPressed){
					var url = e.target.feature.properties.url;
					if(url){
						window.open();
					}
				} else {
					if(e.target.feature.geometry.type == "Polygon"){
						map.fitBounds(e.target.getBounds());
						createMap(e.target.feature.properties.features);
					} else {
						var latlng = e.target.getLatLng(); 
						map.flyTo(latlng, 1);
						var innerHTML = "<a href='javascript:void(0)' class='closebtn' onclick='closePOIInfo()'>&times;</a><h2>" + e.target.feature.properties.name + "</h2><a color='white'>" + e.target.feature.properties.description + "</a><img src='images/" + e.target.feature.properties.image + "'/>"
						openPOIInfo(innerHTML);
					}
					isFeatureClicked = true;
				}
			}

			var currentLayer = 0;
			function createLayerFromZoom(e) {
				if(!isFeatureClicked){
					var newZoom = map.getZoom();
					if(newZoom == -2 && currentLayer != 0){
						createMap(nationsData);
						currentLayer = 0;
					} else if((newZoom == -1 || newZoom == 0) && currentLayer != 1){
						var regionsData = {"type": "FeatureCollection"};
						regionsData.features = new Array();
						var nationFeatures = nationsData.features;
						for (var i in nationFeatures){
							var regionFeatures = nationFeatures[i].properties.features;
							if(regionFeatures){
								Array.prototype.push.apply(regionsData.features, regionFeatures.features);
							}
						}
						createMap(regionsData);
						currentLayer = 1;
					} else if(newZoom > 0 && currentLayer != 2) {
						var poiData = {"type": "FeatureCollection"};
						poiData.features = new Array();
						var nationFeatures = nationsData.features;
						for (var i in nationFeatures){
							var regionFeatures = nationFeatures[i].properties.features;
							if(regionFeatures){
								for(var j in regionFeatures.features){
									var poiFeatures = regionFeatures.features[j].properties.features;
									if(poiFeatures){
										Array.prototype.push.apply(poiData.features, poiFeatures.features);
									}
								}
							}
						}
						createMap(poiData);
						currentLayer = 2;
					}
				}
				isFeatureClicked = false;
			}

			map.on({
			    zoomend: createLayerFromZoom,
			});

			function onEachFeature(feature, layer) {
			    layer.on({
			        mouseover: highlightFeature,
			        mouseout: resetHighlight,
			        click: featureClicked,
			    });
			}

			var info = L.control();

			info.onAdd = function (map) {
			    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
			    this.update();
			    return this._div;
			};

			// method that we will use to update the control based on feature properties passed
			info.update = function (props) {
				var innerHTML = '<h4>Empire Nation Data</h4>'
				if(props){
					innerHTML += '<b>' + props.name + '</b>';
					for (var key in props) {
						if(key != "name" && key != "url" && key != "features" && key != "image" && key != "description"){
							innerHTML += '<br/>' + key + ': ' + props[key];
						}
			        }
		    	} else {
		    		innerHTML += 'Hover over a nation'
		    	}
			    this._div.innerHTML = innerHTML;
			};
			
			var menuButton = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');;
			menuButton.style.backgroundColor = 'white';
			menuButton.id = "menuButton";
		    menuButton.style.width = '30px';
		    menuButton.style.height = '30px';
			menuButton.innerHTML = "<img src='images/menu.png' width='60%' class = 'center'/>";
			menuButton.onclick = function() {
				openNav();
			}

			var myCustomControl = L.Control.extend({
			 
			    options: {
			    	position: 'topleft' 
			    },
			 
				onAdd: function (map) {
			    	return menuButton;
				},
			});
			
			$(document).on("mousedown", function (e) {
			    if(e.ctrlKey){
			    	isCtrlKeyPressed = true;
			    }
			});

			$(document).on("mouseup", function (e) {
			    if(!e.ctrlKey){
			    	isCtrlKeyPressed = false;
			    }
			});

			var poiInfo = document.getElementById("poiInfoPanel");
			if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
				poiInfo.style.right = "-110%";
				poiInfo.style.width = "100%";
			} else {
				poiInfo.style.right = "-50%";
				poiInfo.style.width = "40%";
			}

			function openPOIInfo(innerHTML){
				poiInfo.innerHTML = innerHTML;
				poiInfo.style.right = 0;
			}

			function closePOIInfo(){
				var poiInfo = document.getElementById("poiInfoPanel");
				poiInfo.innerHTML = "";
				if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
					poiInfo.style.right = "-110%";
				} else {
					poiInfo.style.right = "-50%";
				}
			}

			function openNav() {
				if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
					document.getElementById("map").style.marginLeft = "150px";
				} else {
			    	document.getElementById("map").style.marginLeft = "250px";
				}
			    document.getElementById("menuButton").onclick = closeNav;
			}

			/* Set the width of the side navigation to 0 and the left margin of the page content to 0 */
			function closeNav() {
			    document.getElementById("map").style.marginLeft = "0";
			    document.getElementById("menuButton").onclick = openNav;
			}

			L.Control.MousePosition = L.Control.extend({
			  options: {
			    position: 'bottomleft',
			    separator: ' : ',
			    emptyString: 'Unavailable',
			    lngFirst: false,
			    numDigits: 5,
			    lngFormatter: undefined,
			    latFormatter: undefined,
			    prefix: ""
			  },

			  onAdd: function (map) {
			    this._container = L.DomUtil.create('div', 'leaflet-control-mouseposition');
			    L.DomEvent.disableClickPropagation(this._container);
			    map.on('mousemove', this._onMouseMove, this);
			    this._container.innerHTML=this.options.emptyString;
			    return this._container;
			  },

			  onRemove: function (map) {
			    map.off('mousemove', this._onMouseMove)
			  },

			  _onMouseMove: function (e) {
			    var lng = this.options.lngFormatter ? this.options.lngFormatter(e.latlng.lng) : L.Util.formatNum(e.latlng.lng, this.options.numDigits);
			    var lat = this.options.latFormatter ? this.options.latFormatter(e.latlng.lat) : L.Util.formatNum(e.latlng.lat, this.options.numDigits);
			    var value = this.options.lngFirst ? lng + this.options.separator + lat : lat + this.options.separator + lng;
			    var prefixAndValue = this.options.prefix + ' ' + value;
			    this._container.innerHTML = prefixAndValue;
			  }

			});

			L.Map.mergeOptions({
			    positionControl: false
			});

			L.Map.addInitHook(function () {
			    if (this.options.positionControl) {
			        this.positionControl = new L.Control.MousePosition();
			        this.addControl(this.positionControl);
			    }
			});

			L.control.mousePosition = function (options) {
			    return new L.Control.MousePosition(options);
			};

			L.control.mousePosition().addTo(map);

			info.addTo(map);

			map.addControl(new myCustomControl());
			map.fitBounds(bounds);
		</script>
	</body>
</html>