<!DOCTYPE html>
<!-- saved from url=(0066)https://leafletjs.com/examples/crs-simple/crs-simple-example1.html -->
<html id="index">
	<head>
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#2b5797">
		<meta name="theme-color" content="#ffffff">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		
		<title>The Empire</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" type="text/css" href="css/myleaflet.css">
		<link rel="stylesheet" type="text/css" href="css/poiinfo.css">
		<link rel="stylesheet" type="text/css" href="css/sidenav.css">
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>

	   	<!-- Make sure this exists AFTER Leaflet's CSS -->
	 	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
	   	<script src="js/jquery-3.3.1.js"></script>
	   	<script src="js/activearea.js"></script>
		
	</head>
	<body data-gr-c-s-loaded="true" class="noscrol">
		<div id="mySidenav" class="sidenav">
			<div class="content">
				<h2>Nations</h2>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/The_Marches" onclick="return sideNavClick(this, event);">The Marches</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/The_Brass_Coast" onclick="return sideNavClick(this, event);">The Brass Coast</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/Dawn" onclick="return sideNavClick(this, event);">Dawn</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/Highguard" onclick="return sideNavClick(this, event);">Highguard</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/Imperial_Orcs" onclick="return sideNavClick(this, event);">Imperial Orcs</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/The_League" onclick="return sideNavClick(this, event);">The League</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/Navarr" onclick="return sideNavClick(this, event);">Navarr</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/Urizen" onclick="return sideNavClick(this, event);">Urizen</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/Varushka" onclick="return sideNavClick(this, event);">Varushka</a>
			    <a href="https://www.profounddecisions.co.uk/empire-wiki/Wintermark" onclick="return sideNavClick(this, event);">Wintermark</a>
		    </div>
		    <div class="footer">
		    	<hr/>
			    <h2>Tips:</h2>
				<ul>
				  	<li>Hold control when clicking to open wiki</li>
				  	<li>Hold alt when clicking to open POI Info</li>
				  	<li>When zooming by clicking, you will only see things in that area</li>
				</ul>
			</div>
		</div>

		<div id="poiInfoPanel" class="poiInfo" value></div>

		<div id="map" class="main"></div>

		<script src="js/poiinfo.js"></script>
		<script>
			var ignoreList = function(key){
				retValue = key == "name" ? true :
				key == "url" ? true :
				key == "features" ? true :
				key == "image" ? true :
				key == "description" ? true :
				key == "colour" ? true :
				key == "data" ? true :
				key == "type" ? true :
				key == "background" ? true :
				false;
				return retValue;
			};

			var minZoom = -2;
			var nationZoom = -2;
			var regionMinZoom = -1;
			var poiMinZoom = 1;

			function sideNavClick(t, e){
				if(e.ctrlKey){
					return true;
				} else {
					return false;
				}
			}

			var map = L.map('map', {
				minZoom: minZoom,
				crs: L.CRS.Simple
			});

			var isCtrlKeyPressed = false;
			var isAltKeyPressed = false;
			var bounds = [[0,0], [4811,6428]];
			var image = L.imageOverlay('images/main.png', bounds).addTo(map);

			var geojson = new L.geoJson();
			var nationsData = {};

			var xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function() {
			    if (this.readyState == 4 && this.status == 200) {
			        nationsData = JSON.parse(this.responseText);
			        var astolatBounds = [[2000,2000], [2000,2000]];
					var astolatImage = L.imageOverlay('images/astolat.png').addTo(map);
			        createLayerFromZoom(nationsData);
			    }
			};
			xmlhttp.open("GET", "data/geodata.json", true);
			xmlhttp.send();

			function createMap(data){
				map.removeLayer(geojson);

				geojson = L.geoJson(data, {
				    style: style,
				    onEachFeature: onEachFeature
				}).addTo(map);
			}

			function style(feature) {
				var colour = feature.properties.colour;
				var background = feature.properties.background;

				var returnObj = {
			        weight: 1,
			        opacity: 1,
			        color: 'black',
			        dashArray: '3',
			        fillOpacity: 0.5
			    };

				/*if(background){
					returnObj.image = "images/" + background;
				} else*/ 
				if(colour){
					returnObj.fillColor = colour;
				}

				return returnObj; 
			}

			function arrayIncludes(array, element){
				for(var i in array){
					if(array[i].properties.name == element.properties.name){
						return true;
					}
				}
				return false;
			}

			var ignoreMouseOut = false;
			function highlightFeature(e) {
				if(!ignoreMouseOut){
				    var layer = e.target;
				    if(layer.feature.geometry.type == "Polygon" || layer.feature.geometry.type == "MultiPolygon"){
					    layer.setStyle({
					        weight: 5,
					        color: '#666',
					        dashArray: '',
					        fillOpacity: 0.7
					    });

					    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
					        layer.bringToFront();
					    }
					}
				    info.update(layer.feature.properties);
				}
			}

			function resetHighlight(e) {
				if(!ignoreMouseOut){
				    geojson.resetStyle(e.target);
				    info.update();
				}
			}

			var featureBuffer = new Array();
			function featureClicked(e) {
				var geometryType = e.target.feature.geometry.type;
				if(isCtrlKeyPressed){
					var url = e.target.feature.properties.url;
					if(url){
						window.open(url);
					}
				} else if (isAltKeyPressed || geometryType == "Point"){
					openPOIInfo(map, e);
					var layer = e.target;
					if(layer.feature.geometry.type == "Polygon"){
					    layer.setStyle({
					        weight: 5,
					        color: '#666',
					        dashArray: '',
					        fillOpacity: 0.7
					    });

					    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
					        layer.bringToFront();
					    }
					}
				    info.update(layer.feature.properties);
				} else {
					var newBounds = map.fitBounds(e.target.getBounds());

					/*featureBuffer = new Array();
					var features = e.target.feature.properties.features.features;
					for(var i in features){
						featureBuffer.push(features[i]);
					}*/
					//createLayerFromZoom(nationsData);
				}
			}

			var savedZoom = minZoom;
			function saveZoom(){
				savedZoom = map.getZoom();
			}

			function createLayerFromZoom(data) {
				if(!ignoreMouseOut){
					var newZoom = map.getZoom();
					var mapData = {"type": "FeatureCollection"};
					var toSave = function(type){
						return false;
					};
					if(newZoom >= poiMinZoom) {
						toSave = function(type){
							return type == "region" ? true : type == "poi" ? true : false
						};
					} else if(newZoom >= regionMinZoom){
						toSave = function(type){
							return type == "region" ? true : false;
						};
					} else if(newZoom >= nationZoom){
						toSave = function(type){
							return type == "nation" ? true : false;
						};
					}
					mapData.features = createLayerFromZoomRec(data, toSave, featureBuffer);
					for(var i in featureBuffer){
						mapData.features.push(featureBuffer[i]);
					}
					featureBuffer = new Array();
					createMap(mapData);
				}
			}

			function createLayerFromZoomRec(data, toSave, ignoreArray){
				var returnArray = new Array();
				if(data.properties){
					if(toSave(data.properties.type) && (!ignoreArray || !arrayIncludes(ignoreArray, data))){
						returnArray.push(data);
					}
					if(data.properties.features && data.properties.features.features){
						var dataFeatures = data.properties.features.features;
						if(dataFeatures){
							for (var i in dataFeatures){
								var dataFeature = dataFeatures[i];
								var dataFeatureArr = createLayerFromZoomRec(dataFeature, toSave, ignoreArray);
								for(var j in dataFeatureArr){
									returnArray.push(dataFeatureArr[j]);
								}
							}
						}
					}
				}

				return returnArray;
			}

			map.on({
				zoomstart: saveZoom,
			    zoomend: function(e){createLayerFromZoom(nationsData);},
			});

			function onEachFeature(feature, layer) {
			    layer.on({
			        mouseover: highlightFeature,
			        mouseout: resetHighlight,
			        click: featureClicked,
			    });
			}

			var info = L.control();

			info.onAdd = function (map) {
			    this._div = L.DomUtil.create('div', 'info');
			    this.update();
			    return this._div;
			};

			info.update = function (props) {
				var innerHTML = '<h4>Empire Nation Data</h4>'
				if(props){
					innerHTML += '<b>' + props.name + '</b>';
					for (var key in props) {
						if(!ignoreList(key)){
							innerHTML += '<br/>' + key + ': ' + props[key];
						}
			        }
		    	} else {
		    		innerHTML += 'Hover over a nation'
		    	}
			    this._div.innerHTML = innerHTML;
			};
			
			var menuButton = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');;
			menuButton.style.backgroundColor = 'white';
			menuButton.id = "menuButton";
		    menuButton.style.width = '30px';
		    menuButton.style.height = '30px';
			menuButton.innerHTML = "<img src='images/menu.png' width='60%' class = 'center'/>";
			menuButton.onclick = function() {
				openNav();
			}

			var myCustomControl = L.Control.extend({
			 
			    options: {
			    	position: 'topleft' 
			    },
			 
				onAdd: function (map) {
			    	return menuButton;
				},
			});
			
			$(document).on("keydown", function (e) {
			    if(e.ctrlKey){
			    	isCtrlKeyPressed = true;
			    }
			    if(e.altKey){
			    	isAltKeyPressed = true;
			    }
			});

			$(document).on("keyup", function (e) {
			    if(!e.ctrlKey){
			    	isCtrlKeyPressed = false;
			    }
			    if(!e.altKey){
			    	isAltKeyPressed = false;
			    }
			});

			function openNav() {
				if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
					document.getElementById("map").style.marginLeft = "250px";
				} else {
			    	document.getElementById("map").style.marginLeft = "250px";
				}
			    document.getElementById("menuButton").onclick = closeNav;
			}

			function closeNav() {
			    document.getElementById("map").style.marginLeft = "0";
			    document.getElementById("menuButton").onclick = openNav;
			}

			L.Control.MousePosition = L.Control.extend({
			  options: {
			    position: 'bottomleft',
			    separator: ' : ',
			    emptyString: 'Unavailable',
			    lngFirst: false,
			    numDigits: 5,
			    lngFormatter: undefined,
			    latFormatter: undefined,
			    prefix: ""
			  },

			  onAdd: function (map) {
			    this._container = L.DomUtil.create('div', 'leaflet-control-mouseposition');
			    L.DomEvent.disableClickPropagation(this._container);
			    map.on('mousemove', this._onMouseMove, this);
			    this._container.innerHTML=this.options.emptyString;
			    return this._container;
			  },

			  onRemove: function (map) {
			    map.off('mousemove', this._onMouseMove)
			  },

			  _onMouseMove: function (e) {
			    var lng = this.options.lngFormatter ? this.options.lngFormatter(e.latlng.lng) : L.Util.formatNum(e.latlng.lng, this.options.numDigits);
			    var lat = this.options.latFormatter ? this.options.latFormatter(e.latlng.lat) : L.Util.formatNum(e.latlng.lat, this.options.numDigits);
			    var value = this.options.lngFirst ? lng + this.options.separator + lat : lat + this.options.separator + lng;
			    var prefixAndValue = this.options.prefix + ' ' + value;
			    this._container.innerHTML = prefixAndValue;
			  }

			});

			L.Map.mergeOptions({
			    positionControl: false
			});

			L.Map.addInitHook(function () {
			    if (this.options.positionControl) {
			        this.positionControl = new L.Control.MousePosition();
			        this.addControl(this.positionControl);
			    }
			});

			L.control.mousePosition = function (options) {
			    return new L.Control.MousePosition(options);
			};

			L.control.mousePosition().addTo(map);

			info.addTo(map);

			map.addControl(new myCustomControl());
			map.fitBounds(bounds);
		</script>
	</body>
</html>